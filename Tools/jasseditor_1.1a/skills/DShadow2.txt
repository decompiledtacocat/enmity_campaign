function DemonShadowConditions takes nothing returns boolean
    return ( GetSpellAbilityId() == 'A03D' )
endfunction
function DSCastFullFilter takes nothing returns boolean 
//requires preset udg_tempfilterunit ,udg_tempfilterplayer
return GetBooleanAnd(filtercheck(),( GetFilterUnit() != udg_tempfilterunit ))
endfunction
function DSCastFilter takes nothing returns boolean 
//requires preset udg_tempfilterplayer 
return (filtercheck())
endfunction

function DemonShadowActions takes nothing returns nothing
    local unit dscastunit=GetSpellAbilityUnit()
    local unit dstemptargetunit=GetSpellAbilityUnit()
    local unit dstargetunit
    local unit array dsatkunit
    local location dscastpos=GetUnitLoc(dscastunit)
    local location dstargetlocation
    local integer dsatkcount=0
    local integer dloopindex=1
    local group dstargetgroup
    local group dstargetsubgroup
    local player dscastplayer=GetOwningPlayer(dscastunit)
    local real dsdamageamount=(( 10.00 * I2R(GetUnitAbilityLevelSwapped('A03D', dscastunit)) ) + ( GetRandomReal(1.00, 6.00) + ( 4.00 * I2R(GetHeroLevel(dscastunit)) ) ) )
    set udg_tempfilterplayer=dscastplayer
    set udg_tempfilterunit=dstemptargetunit
    set dstargetsubgroup=GetUnitsInRangeOfLocMatching(700.00, dscastpos, Condition(function DSCastFullFilter))
    set udg_tempfilterplayer=null
    set udg_tempfilterunit=null
    if ( CountUnitsInGroup(dstargetsubgroup) <= 1 ) then
        set dsatkcount = 4
    else
        set dsatkcount = 8
    endif
    call DestroyGroup(dstargetsubgroup)
    call ShowUnitHide( dscastunit )
    call PauseUnitBJ( true, dscastunit ) 
    set dloopindex = 0
    loop
        exitwhen dloopindex >= dsatkcount
        set dsatkunit[dloopindex]=CreateUnitAtLoc( dscastplayer, 'h00G', dscastpos, GetRandomDirectionDeg() )
        call IssueImmediateOrderBJ( dsatkunit[dloopindex], "channel" )
        set dloopindex = dloopindex + 1
    endloop 
    
    call TriggerSleepAction( 0.05 )
    set dloopindex = 0
    
    loop
            exitwhen dloopindex >= dsatkcount
            set udg_tempfilterplayer=null
            set udg_tempfilterunit=null
            set udg_tempfilterplayer=dscastplayer
            set udg_tempfilterunit=dstemptargetunit
            set dstargetgroup=GetUnitsInRangeOfLocMatching(700.00, dscastpos, Condition(function DSCastFullFilter))
            set dstargetunit=GroupPickRandomUnit(dstargetgroup) 
            set dstargetsubgroup=GetUnitsInRangeOfLocMatching(700.00, dscastpos, Condition(function DSCastFilter))
         if dstargetunit!=null then     
            if ( CountUnitsInGroup(dstargetsubgroup) == 1 ) then
            set dstemptargetunit =null//destroyed
            set dstemptargetunit = dsatkunit[dloopindex]
            else
            set dstemptargetunit =null//destroyed
            set dstemptargetunit = dstargetunit
            endif
            set dstargetlocation=GetUnitLoc(dstargetunit)
            call SetUnitPositionLocFacingLocBJ( dsatkunit[dloopindex], dstargetlocation, dstargetlocation )
            call RemoveLocation(dstargetlocation)//destroyed
            call SetUnitTimeScalePercent( dsatkunit[dloopindex], 200.00 )
            call SetUnitAnimation( dsatkunit[dloopindex], "attack" )
            call QueueUnitAnimationBJ( dsatkunit[dloopindex], "stand" )
            set udg_tempecheckunit=dstargetunit 
            if ( etherealcheck() ) then
            call UnitDamageTargetBJ( dscastunit, dstargetunit , dsdamageamount, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_NORMAL )
            else
            call UnitDamageTargetBJ( dscastunit, dstargetunit , dsdamageamount, ATTACK_TYPE_MELEE, DAMAGE_TYPE_NORMAL )
            endif
            set udg_tempecheckunit=null
            call PlaySoundOnUnitBJ( gg_snd_MetalHeavySliceFlesh2, 100, dsatkunit[dloopindex])
            call KillSoundWhenDone(GetLastPlayedSound())
        endif
        call DestroyGroup(dstargetgroup)
        call DestroyGroup(dstargetsubgroup)
        set dstargetunit=null   
        set dloopindex = dloopindex + 1
    endloop
    
    call TriggerSleepAction( 0.20 )
    
    if ( (dsatkcount > 4 ) ) then
       set dloopindex = 0
    loop
            exitwhen dloopindex >= dsatkcount
            set udg_tempfilterplayer=null
            set udg_tempfilterunit=null
            set udg_tempfilterplayer=dscastplayer
            set udg_tempfilterunit=dstemptargetunit
            set dstargetgroup=GetUnitsInRangeOfLocMatching(700.00, dscastpos, Condition(function DSCastFullFilter))
            set dstargetunit=GroupPickRandomUnit(dstargetgroup) 
            set dstargetsubgroup=GetUnitsInRangeOfLocMatching(700.00, dscastpos, Condition(function DSCastFilter))
        if dstargetunit!=null then   
            if ( CountUnitsInGroup(dstargetsubgroup) == 1 ) then
            set dstemptargetunit =null//destroyed
            set dstemptargetunit = dscastunit
            else
            set dstemptargetunit =null//destroyed
            set dstemptargetunit = dstargetunit
            endif
            set dstargetlocation=GetUnitLoc(dstargetunit)
            call SetUnitPositionLocFacingLocBJ( dsatkunit[dloopindex], dstargetlocation, dstargetlocation )
            call RemoveLocation(dstargetlocation)//destroyed
            call SetUnitTimeScalePercent( dsatkunit[dloopindex], 200.00 )
            call SetUnitAnimation( dsatkunit[dloopindex], "attack" )
            call QueueUnitAnimationBJ( dsatkunit[dloopindex], "stand" )
            set udg_tempecheckunit=dstargetunit 
            if ( etherealcheck() ) then
            call UnitDamageTargetBJ( dscastunit, dstargetunit , dsdamageamount, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_NORMAL )
            else
            call UnitDamageTargetBJ( dscastunit, dstargetunit , dsdamageamount, ATTACK_TYPE_MELEE, DAMAGE_TYPE_NORMAL )
            endif
            set udg_tempecheckunit=null
            call PlaySoundOnUnitBJ( gg_snd_MetalHeavySliceFlesh2, 100, dsatkunit[dloopindex])
            call KillSoundWhenDone(GetLastPlayedSound())
        endif
        call DestroyGroup(dstargetgroup)
        call DestroyGroup(dstargetsubgroup)
        set dstargetunit=null    
        set dloopindex = dloopindex + 1
        endloop
    endif
  
    call TriggerSleepAction( 0.20 )
    set dloopindex = 0
    
    loop
        exitwhen dloopindex >= dsatkcount
        call SetUnitPositionLocFacingLocBJ( dsatkunit[dloopindex],dscastpos, dscastpos )
        call IssueImmediateOrderBJ( dsatkunit[dloopindex], "channel" )
        set dloopindex = dloopindex + 1
    endloop
    
    call TriggerSleepAction( 0.20 )
    set dloopindex = 0
    loop
        exitwhen dloopindex >= dsatkcount
        call SetUnitPositionLocFacingLocBJ( dsatkunit[dloopindex], dscastpos, dscastpos )
        call IssueImmediateOrderBJ( dsatkunit[dloopindex], "channel" )
        set dloopindex = dloopindex + 1
    endloop
    call TriggerSleepAction( 0.10 )
    set dloopindex = 0
    loop
        exitwhen dloopindex >= dsatkcount
        call KillUnit( dsatkunit[dloopindex] )
        call RemoveUnit( dsatkunit[dloopindex] )
        set dsatkunit[dloopindex]=null
        set dloopindex = dloopindex + 1
    endloop
    call PauseUnitBJ( false, dscastunit )
    call ShowUnitShow( dscastunit )
    call SetUnitPositionLoc( dscastunit, dscastpos)
    call SelectUnitAddForPlayer( dscastunit, dscastplayer )
    set dscastunit=null
    set dscastplayer=null
    set dstemptargetunit=null
    set dstargetunit=null
    call RemoveLocation (dscastpos)
    call RemoveLocation(dstargetlocation)
    call DestroyGroup(dstargetgroup)
    call DestroyGroup(dstargetsubgroup)
endfunction 


//===========================================================================
function InitTrig_DemonShadow takes nothing returns nothing
    set gg_trg_DemonShadow = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_DemonShadow, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_DemonShadow, Condition( function DemonShadowConditions ) )
    call TriggerAddAction( gg_trg_DemonShadow, function DemonShadowActions )
endfunction
